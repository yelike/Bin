name: armv8æ‰“åŒ…

on:
  repository_dispatch:
    types: [db]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'db'
        required: false
        default: 'false'
  schedule:
    - cron: 30 23 * * *

env:
  kREPO_URL: https://github.com/coolsnowwolf/lede #å¼€å‘ç‰ˆä»“åº“
  wREPO_URL: https://github.com/coolsnowwolf/openwrt #ç¨³å®šç‰ˆä»“åº“
  kREPO_BRANCH: master #å¼€å‘ç‰ˆåˆ†æ”¯
  wREPO_BRANCH: lede-17.01 #ç¨³å®šç‰ˆåˆ†æ”¯
  UPLOAD_BIN_DIR: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:

  kbuild+0: #å¼€å‘+0ç‰ˆ
    runs-on: ubuntu-18.04
    steps:    
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # è·å–æ›´æ–°ä¿¡æ¯
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $kREPO_URL -b $kREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•:<br/>æ›´æ–°äºº: %an<br/>æ›´æ–°æ—¶é—´: %cd<br/>æ›´æ–°å†…å®¹: %s<br/>å“ˆå¸Œå€¼: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")" >> $GITHUB_ENV
    - name: Build firmware #æ‰“åŒ…
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/å…¬å‘Š/img+0.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8å¼€å‘ç‰ˆ/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./mk_beikeyun_opimg.sh
        sudo ./mk_l1pro_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #ä¸Šä¼ artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: k+0
        path: ${{ env.FIRMWARE }}
    - name: Create release #å‘å¸ƒ
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} ğŸš€ armv8å¼€å‘ç‰ˆ | è‡ªåŠ¨ç¼–è¯‘
        allowUpdates: true
        tag: armv8å¼€å‘ç‰ˆ
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  kbuild+: #å¼€å‘+ç‰ˆ
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # è·å–æ›´æ–°ä¿¡æ¯
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $kREPO_URL -b $kREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•:<br/>æ›´æ–°äºº: %an<br/>æ›´æ–°æ—¶é—´: %cd<br/>æ›´æ–°å†…å®¹: %s<br/>å“ˆå¸Œå€¼: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")" >> $GITHUB_ENV
    - name: Build firmware #æ‰“åŒ…
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/å…¬å‘Š/img+.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8å¼€å‘ç‰ˆ/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #ä¸Šä¼ artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: k+
        path: ${{ env.FIRMWARE }}
    - name: Create release #å‘å¸ƒ
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} ğŸš€ armv8å¼€å‘ç‰ˆ | è‡ªåŠ¨ç¼–è¯‘
        allowUpdates: true
        tag: armv8å¼€å‘ç‰ˆ
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  wbuild+0: #ç¨³å®š+0ç‰ˆ
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # è·å–æ›´æ–°ä¿¡æ¯
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $wREPO_URL -b $wREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•:<br/>æ›´æ–°äºº: %an<br/>æ›´æ–°æ—¶é—´: %cd<br/>æ›´æ–°å†…å®¹: %s<br/>å“ˆå¸Œå€¼: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")" >> $GITHUB_ENV
    - name: Build firmware #æ‰“åŒ…
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/å…¬å‘Š/img+0.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8ç¨³å®šç‰ˆ/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./mk_beikeyun_opimg.sh
        sudo ./mk_l1pro_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #ä¸Šä¼ artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: w+0
        path: ${{ env.FIRMWARE }}
    - name: Create release #å‘å¸ƒ
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} ğŸš€ armv8ç¨³å®šç‰ˆ | è‡ªåŠ¨ç¼–è¯‘
        allowUpdates: true
        tag: armv8ç¨³å®šç‰ˆ
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  wbuild+: #ç¨³å®š+ç‰ˆ
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # è·å–æ›´æ–°ä¿¡æ¯
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $wREPO_URL -b $wREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•:<br/>æ›´æ–°äºº: %an<br/>æ›´æ–°æ—¶é—´: %cd<br/>æ›´æ–°å†…å®¹: %s<br/>å“ˆå¸Œå€¼: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")" >> $GITHUB_ENV
    - name: Build firmware #æ‰“åŒ…
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/å…¬å‘Š/img+.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8ç¨³å®šç‰ˆ/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #ä¸Šä¼ artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: w+
        path: ${{ env.FIRMWARE }}
    - name: Create release #å‘å¸ƒ
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} ğŸš€ armv8ç¨³å®šç‰ˆ | è‡ªåŠ¨ç¼–è¯‘
        allowUpdates: true
        tag: armv8ç¨³å®šç‰ˆ
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}
